---
marp: true
title: OS and Command Line
description: Made to lecture in ttc.
url: https://www.ttc-net.co.jp/
---

# 本日は

一旦、コマンドラインインターフェースに慣れましょう。

主に[Linux標準教科書 Ver.3.0.1](https://linuc.org/textbooks/linux/)を使います。
詳しく知りたい方は参照してください。

```
# gccがない人は入れましょう。
gcc --version
sudo apt install -y build-essential
```

---

## CLIとは？

Command Line Interfaceです。
コンピュータと人間のインターフェースです。
コマンドを実行するためのインターフェースです。
コマンドはOSが受け取り実行します。

---

## OSとは？

Operating Systemです。
コンピュータを操作するためのソフトウェアです。

---

## ハードウェアとソフトウェア

コンピュータは、ハードウェアとソフトウェアから構成されます。
ソフトウェアは、基本ソフトウェア、応用ソフトウェアから構成されます。
基本ソフトウェアに当たるのが、OSです。
応用ソフトウェアとは、その名の通りアプリケーションです。
OSは、アプリケーションにハードウェア資源を割り当て、実行を管理します。

アプリケーションの実行は、以下のようなタイミングで行われます。
* コマンドラインにパスを指定した時(CLI)
* マウスでダブルクリックした時(GUI)
* スケジューラに指定の時刻になった時(UIなし)

---

## コマンドラインでエンターキーを押したらどうなるのか？

先頭に指定されたパスのアプリケーションを探して実行してくれます。
GUIでダブルクリックした時も同じです。
このような仕組みを提供するソフトウェアを、シェルと言います。
OSは、シェルや、シェルから実行するファイル操作などの基本的なコマンド、その他ファイルシステムなどを指すユーザランドというソフトウェアと、
ハードウェアの制御を行うカーネルというソフトウェアで構成されます。
よく聞くLinuxカーネルのカーネルとはここの部分を指します。

---

## Linuxとは？

[Linus Torvalds](https://ja.wikipedia.org/wiki/%E3%83%AA%E3%83%BC%E3%83%8A%E3%82%B9%E3%83%BB%E3%83%88%E3%83%BC%E3%83%90%E3%83%AB%E3%82%BA)が開発したカーネルのことです。
カーネル以外のソフトウェアを含めたOSを指す場合、正しくはGNU/Linuxと呼びます。
[GNU](https://www.gnu.org/gnu/linux-and-gnu.ja.html)で開発されたソフトウェア群を使用したOSだからです。
ただし、日本の大体の人はLinuxとか、Linux OSと呼んでいます。

GNU/Linuxは自由ソフトウェアなので、それを元にした派生OSが多数生まれました。
それをディストリビューションと呼びます。
Ubuntuは、Debian GNU/Linuxをベースにして、オープンソースソフトウェアなどを追加しています。

---

## その他の注意

組み込みシステムや、産業機械に使われるOSは、それぞれに特化した全く別の機構を備えているものがあります。
今回学ぶことは、我々のプログラムが動作する範囲での仕組みです。

あと、WindowsはWindowsです。UNIXベースのシステムと似ていますが別のものです。

---

## 注意その２

[危険！決して実行してはいけないLinuxコマンド7個(+1個)])(https://orebibou.com/2014/08/%E5%8D%B1%E9%99%BA%EF%BC%81%E6%B1%BA%E3%81%97%E3%81%A6%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84linux%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89/)

その他、tar cvf や rsync の宛先を間違えて元ファイルを消してしまうなどが容易に発生します。
自分は今、どのシステムを操作しているのか、確認しましょう。
エンターキーを押す前に、何を確認したら良いのか考えましょう。
rmの前にlsをして削除対象のパスを確かめたり、tar cvfの引数の位置を別のファイル、ディレクトリで先に確かめたりする慎重さが必要です。

---

## POSIXについて

UNIX系OSの統一規格です。
POSIXに準拠したカーネルがC言語向けに提供すべきインターフェースなどが定義されています。
移植性の高いアプリケーションソフトウェアの開発を容易にすることを目的としてIEEEが策定したAPI規格です。

---

## 基本的なコマンド

教科書に書いてある主なコマンド。

* ls, cp, mv, rm
* pwd, cd, mkdir, rmdir
* cat, less, find, which, man
* grep
* touch, head, tail, sort, tr, diff
* vi
* ユーザ、グループ管理系
* 権限管理系

---

## その他の知識

### コマンドと引数
```
ls        -a
~~~~~~~~  ~~~~~~~~~~
コマンド  オプション
```

### 特別なディレクトリ(., .., ~, /)
```
du -h .
cd ../
ls ~/.ssh/
cat /proc/
```

---

### 絶対パスと相対パス

/から始めるか、現在のディレクトリから始めるか。

---

### 標準入出力、パイプ、リダイレクト、正規表現

プロセスには、標準入出力が割り当てられる。
標準エラー出力もある。

自分のシェルのPIDを確認
```
ps -efL
pstree
echo $$
```

Linux(UNIX)は、様々なインターフェースをファイルとして扱えるように仮想化している。
標準入出力もその一つ。例えば、ソケットとか、パイプとかも仮想化されており、プロセス間、コンピュータ間の通信もファイルのように取り扱える。
```
ls /proc/$$/
ls /proc/$$/fd
ls -l /proc/$$/fd
```

---

標準エラー出力をリダイレクトしてみる
```
ls xxx 2> error.txt
cat error.txt
```

---

grepしてみる
```
grep `whoami` /etc/passwd
cat /proc/$$/environ # ログインシェルの設定が一致する
```

grepで使う正規表現
```
.
\d
\s
\n
[^a-Z]
()
*
+
```

置換(sedなど)で使う正規表現(パターンマッチ)
```
()を\1とか$1で後方参照できる。
```

正規表現チェッカーなどで練習もできます。

---

## シェルスクリプト

コマンドをまとめて実行できるようにするのがシェルスクリプトです。
分岐、繰り返しもサポートします。
bashを覚えておけばいくらでも応用できます。

```
vi ls.sh
```

ls.sh (lsした時刻もわかる。この程度であれば、ワンライナーとか、bashのaliasでもできますね。)
```
#!/bin/bash
ls -l /proc/$$/fd
date
```

スクリプトの実行には実行権限とパスが必要です。
```
chmod u+x
./ls.sh
```

---

### sourceコマンド

sourceコマンドは、新しいプロセスではなく、現在のプロセスでスクリプトを実行します。
変数の設定や、初期化用のコマンドで用いられます。

```
. ~/.bash_profile
```

とすると、ログイン用の設定を直した際に、シェルを立ち上げ直さなくても反映できます。

---

## プロセスとは？

OSがアプリケーションの実行を管理する単位を指す概念です。
コマンドラインに実行ファイルが指定されると、中身のプログラムとデータを読み込んで、プロセスとして実行を管理します。

[forkしてみましょう。](https://ja.wikipedia.org/wiki/Fork)

コンパイル方法
```
gcc fork.c
  # => a.outと言う実行ファイルができる。
```

実行方法
```
./a.out
```

---

### fork(2)

fork（フォーク）とは、プロセスのコピーを生成するものである。UNIXおよびUnix系OSではシステムコールのひとつで、新たに作り出されたプロセスを子プロセス、fork()を呼び出したプロセスを親プロセスと呼び、fork()システムコールの戻り値によって親と子の処理を区別する。子プロセスではfork()の戻り値は0であり、親プロセスの戻り値は新たに生成された子プロセスのプロセス識別子、エラーが起きた場合は-1である。また、マルチスレッド環境でスレッドのコピーを作ることもforkと呼ぶことがある。

forkが呼び出されると、子プロセスのためのアドレス空間が新たに作成される。子プロセスのアドレス空間には親プロセスが持っていた全セグメントのコピーがあるが、コピーオンライト機能によって実際の物理メモリの確保は遅延される（すなわち、一時的に同じ物理メモリセグメント群を親子で共有する）。親プロセスと子プロセスは同じコードセグメントを持つが、独立して実行される。

---

### シグナル

プロセスには、シグナルを送れます。
killというコマンドは、SIGTERMを送るのがデフォルトです。
強制終了は、SIGKILL(`kill -9`)です。

---

### スレッドとは？

プロセスをさらに効率化しようとした単位のことです。
OSから見た場合プロセスと同じ様に管理されます。

---

## OSが提供するその他の仮想化機能

### ファイルシステム

別々のディスクでも、マウントすることで統一したパス表現でアクセスできます。
リモートシステムのディスクも同様です。

### メモリ管理の仮想化

プロセスには、使えるメモリ量だけ教えます。
物理メモリのどこを使うかは、OSが決めます。
OSは、メモリをページという単位で管理しており、
ページフォルトが起きると仮想メモリ(スワップ)を使うといったことをしてくれます。

以上
