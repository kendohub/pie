---
marp: true
title: Testing
description: Made to lecture in ttc.
url: https://www.ttc-net.co.jp/
---

# 本日は

テストに関する一般知識を学びます。
テストの呼び方、テスト手法、プロジェクトにおけるテストの位置づけなどです。

```
sudo apt install -y python3-pip
pip3 install coverage
# Visual Studio Codeもインストールしましょう。
```

---

## テストの種類

単体テスト、結合テスト、総合テストなど、テストの呼び名は様々あります。
それぞれどのようなものを指すのでしょうか。

---

### 単体テスト

プログラムの部品単位でのテストを行います。
これが単体テスト、と言う一般的な定義はありません。
関数単位、モジュール単位、機能単位など、プロジェクトによって粒度は別れます。

---

### 結合テスト

プログラムを組み合わせた一部分をテストします。
モジュール単位、機能を構成するモジュールの組合せ単位、システム全体など、プロジェクトによって粒度は別れます。

---

### 総合テスト

システムを総合的に動かし、機能をテストします。
プロジェクトによって、呼び方やテスト範囲は様々です。
結合テストを総合テストと呼ぶ場合や、統合テストと呼ぶ場合があったり、その代わり総合テストが無かったりする場合もありますので、プロジェクト毎のやり方に合わせましょう。

---

### 受け入れテスト(検収)

システムが要求通り動作するかをテストします。
通常は発注者が行います。

---

### 運用テスト

システムをユーザーに実際の業務で使ってもらいテストします。
世に言うアルファテスト、ベータテストなども同じ考え方です。
想定外の操作や負荷が掛かることなどによる不具合を検出できます。
システムの入れ替えや新規構築の場合は行うべきでしょう。

---

### ここまでは

主に機能に着目したテストです。
ユーザーと、こう言う機能が欲しい、などと話しながらシステムを作っていれば、テストを作りやすいですね。
これ以外の視点でもテストをする必要があります。
[非機能要求](https://www.ipa.go.jp/sec/reports/20180425.html) と言う観点です。

---

### 負荷テスト

システムがどれだけの負荷に耐えられるかをテストします。
想定する負荷を超えた場合のシステムの挙動も確認し、必要であればリミッターを設けるなどして制御できるようにします。
同時にパフォーマンスを図り、達成基準とすることが多いです。
パフォーマンスは、ユーザーへの応答時間や、ジョブの処理時間、それらに消費するコンピューター資源のバランスを指標にします。

例えば、どんなに早く応答できても、100人が利用するシステムにCPUを100コア割り当てないと快適な応答時間が担保できないとしたら、どう考えるべきでしょうか？
また、利用者が10,000人いるシステムでも、全ての利用者が全く同時に利用しているでしょうか？
これらは、費用対効果や、ユーザーの業務への理解がないと解を出せません。

---

### セキュリティテスト

ネットワーク検査とか、ペネトレーションテストなど、様々な視点でセキュリティをテストします。
システムに既知の脆弱性があり、それを利用して攻撃が成立するかと言う観点です。
単純なブログサイトであれば、Webアプリケーションの一般的な脆弱性に対応できているか、インターネットを介してサーバーへの侵入や攻撃が可能か、といったものです。
攻撃の成立する仕組みを理解できないうちは、 [IPAのガイドライン](https://www.ipa.go.jp/security/vuln/websecurity.html) に従っていれば、まずまず安心できるでしょう。

---

### 耐障害性のテスト

システムを構成する要素の一部または全部が欠落した場合に、どの様な状態になるかをテストします。
一般的には、セキュリティの一部で、可用性と呼ばれるものです。
データベースのデータが存在するディスクが破損した場合、どこまでデータを復旧できるか、バックアップは取れており、復旧可能か。または、影響なく動作可能にできるかなどといった観点です。
ユーザーからシステムの入り口まで、システムの入り口からシステムを構成する全ての要素まで、どれが欠けても事前に想定した対応が取れる様に準備します。

---

### 使用性のテスト

ユーザビリティと呼ばれるものです。
人間がどれだけシステムを使いやすいかと言う観点です。
画面のボタンやテキスト項目が統一して配置、配色、制御されているかや、非同期処理によってユーザーを待たせないなどの配慮も含みます。

---

### 長くなりましたが

機能的なテスト、非機能的なテスト、それぞれの必要性が分かりましたか？
話はまだ結構あるので頑張りましょう。

---

## ホワイトボックステスト、ブラックボックステスト

ホワイトボックステストは、コードを見てテストケースを抽出します。
ブラックボックステストは、機能定義からテストケースを抽出します。

例えば、業務システムに、社員、契約社員は利用可能だが、派遣社員は利用不可のボタンがあった場合、どの様なテストになるでしょうか？

---

### ホワイトボックス的

|ユーザー種別|結果|
| ---- | ---- |
|社員または準社員|利用可能|
|派遣社員|利用不可|

---

### ブラックボックス的

|ユーザー種別|結果|
| ---- | ---- |
|社員|利用可能|
|契約社員|利用可能|
|派遣社員|利用不可|

---

### ホワイトボックステストの網羅性

先の例では、「社員」のデータに対してしかテストせず、「契約社員」の場合の予期せぬバグを見つけられない可能性があります。
しかし、実用的には問題ないでしょう。

参考までに、テストによって、
コード中の全ての命令が実行されるかと言う観点をC0(ステートメントカバレッジ)、
全ての分岐のどちらも実行されるかと言う観点をC1(ブランチカバレッジ)、
分岐判定条件の全ての真偽値の組み合わせが実行されるかと言う観点をC2カバレッジ(コンディションカバレッジ)と言います。

---

### テストしてみましょう

以下のテストを通る関数をuser_type.pyに定義してください。

test_user_type.py
```
import unittest
import user_type as ust

class TestUserType(unittest.TestCase):
  def test_button_available(self):
    actual = ust.button_available("社員")
    self.assertTrue(actual)

    actual = ust.button_available("契約社員")
    self.assertTrue(actual)

    actual = ust.button_available("派遣社員")
    self.assertFalse(actual)

if __name__ == '__main__':
    unittest.main()
```

---

### カバレッジを測定しましょう。

Visual Studio CodeでWSLに接続し、以下を実行してください。
Visual Studio Codeに、[Code Coverage Hilighter](https://marketplace.visualstudio.com/items?itemName=brainfit.vscode-coverage-highlighter) プラグインをインストールしてください。

```
coverage run -m unittest discover
coverage report
coverage xml
```

---

### カバレッジの確認

reportには、C0カバレッジが表示されます。
xmlは、Visual Studio Codeでテスト対象のコードを開き、`Ctrl+Shift+P` `Code Coverage: Toggle coverage display` で見られます。
どこがテストされているか、一目瞭然ですね。

---

## テストと開発手法

先ほどの様に、テストを書きながら機能を追加していくと、安心感がありますね。
テストを先に書くと言う手法を発展させて、テスト駆動開発(TDD)、振る舞い駆動開発(BDD)、受け入れテスト駆動開発(ATDD)など、様々な手法が考案されています。
これらは、単体テストだけでなく、統合テストや負荷テストを支援するツール、ビルドやデプロイを自動化するツールなどを複合的に取り入れて、継続的に安定したシステムをリリースできることを目指しています。

---

## 安定したシステムのためのコード

テストが書けるシステムは安定します。
テストが書きづらいな、と思うコードは、不要に複雑なことをしすぎているためです。
関数やメソッドを適切に分割して、テストがしやすいコードを保ちましょう。
関数単体ではテストできない場合、スタブやモックを使うことができます。

---

### 関数やメソッドの分割単位

モジュール強度という言葉があります。
極端な例では、グローバル変数を使っていたら、強度は最低です。
他者に副作用を与えるものは強度が低いです。
どれだけ、入力に対して出力を返すだけという関数本来の独立性、単純さを保てているかという基準です。

また、テストの網羅性から見て分かる通り、不要に分岐をしているコードはテストが大きくなりすぎます。実行にも時間がかかり、次第にテストもされなくなってしまいます。

これらを少しずつでも意識しながらコードを書くことで勘所が身につきます。

---

## 以上

書いたコードをGitHubにアップしたら終了です。

---

## インストールコマンド

```
sudo apt install -y python3-pip
pip3 install coverage
# Visual Studio Codeもインストールしましょう。
```
